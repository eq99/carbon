# 背景

由于自己办了一个学习网站，因此会有很多文档资料需要存储，这些文档资料有两个重要的需求：一个是版本迭代，另一个是协作。



# 书籍结构需求

学习网站的基本组成单位是课堂笔记，例如数据结构、高等数学、线性代数，它的组织模式也像一本书，我们不妨把它看做一本书。

一般的书籍结构是三级标题：

- 章标题
- 节标题
- 小节标题

根据互联网文章的特点，一般会把节这个层次组织为一个网页，然后在这篇文章里面用小节标题分块。经典的例子可以参考 [The Rust Programming Language](https://doc.rust-lang.org/book/title-page.html#the-rust-programming-language)。

我们的存储系统需要能够反应书籍的层次结构，即书--->章--->节。

:bulb:解决方案：



# 文件格式需求

文本文档可以用标记语言实现，例如 markdown。

还有其他形式的文件例如：图片、视频、docx、pptx。



:bulb:解决方案：

文本文件使用版本控制工具管理。

图片通过搭建图床服务以超链接的形式引入。

代码文件通过git服务以自定义模块应用形式引入，或使用类似Markdown的代码块。

视频、pptx, docx等以嵌入式模块引入。



# 版本控制、协作需求

学习网站的文字资料需要有一种进化机制，即版本迭代，创作者会不断完善修改文档。

学习网站打算做成一个开放的平台，即大家可以提交修改建议，然后由管理员决定是否接受该用户的修改。



:bulb:解决方案：

可以模仿git，文件保存为Blob对象，文件名是文件内容的哈希值。

然后创建一个Meta对象，用于存储文件的源信息，例如文件哈希值，修改时间，修改作者。

- 如何实现版本控制？

以文件为单位进行版本控制。版本控制历史线由主线与支线构成，主线由管理员维护，支线由协作者创建。每次主线的修改保存为一次修改记录，用 Meta 对象表示，Blob 保存的基于上一次修改的 Difference。为了得到当前文件，需要从头遍历整个主线的修改历史。为了加速这一过程，把一些历史标记为发布版，这些发布版保存了当前文件的结果，因此不需要从最开始遍历，只需要从最近发布版遍历即可。

- 协作的流程是怎样的？

管理员做的修改直接记录在主线上面，其他人基于最近发布版做修改然后提交，管理员比对两次修改，决定要不要接受所做的修改，如果拒绝，则标记这次修改无效，否则把所做的修改合并到主线上面。

- 这套系统如何追踪多个文件的历史？

在单个文件版本控制的基础上，用一个特殊的文件 Repo 记录多个文件的最近修改，最近发布版，并且按照文件记录顺序表示章节顺序。

- 文件删除了怎么办？

删除文件销毁历史是不明智的选择。项目中被删除的文件首先被移到 Trash 记录中，这个文件在 Repo 中记录。

系统定时检查Trash文件，位于Trash文件中的记录超过一段时间之后会从生产环境移入归档环境中，此时生产环境是真的删除了。



# 系统集成需求

由于学习网站还有其他功能，例如用户管理，需要划分清楚服务界限。版本系统提供 native API，也可以封装Rest ful API。

